<!DOCTYPE HTML>
	<html lang="en-US">
		<head>
			<title>APRS-Server</title>
			<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
			<meta name="robots" content="index" />
			<meta name="robots" content="follow" />
			<meta name="language" content="English" />
			<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
			<meta http-equiv="cache-control" content="max-age=0" />
			<meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
			<meta http-equiv="expires" content="0" />
			<meta http-equiv="pragma" content="no-cache" />
			<script src="jquery.js"></script>
			<script src="jQueryRotate.js"></script>
			<script src="leaflet.js"></script>
			<script src="L.Control.Zoomslider.js"></script>
			<script src="L.Terminator.js"></script>
			<script src="L.Control.MousePosition.js"></script>
			<script src="leaflet-heat.js"></script>
			<script src="leaflet.label.js"></script>
			<link rel="stylesheet" href="style/leaflet/leaflet.css" />
			<link rel="stylesheet" href="style/leaflet/L.Control.Zoomslider.css" />
			<link rel="stylesheet" href="style/leaflet/L.Control.MousePosition.css" />
			<link rel="stylesheet" href="style/leaflet/leaflet.label.css" />
			<link rel="stylesheet" href="style/w3.css">
			<link rel="stylesheet" href="style/custom.css">
		</head>
		<body class="w3-theme-dark">
			<div id="preloader" role="status" aria-live="polite">
				<div class="loader-ring"></div>
				<div id="preloaderTitle" style="font-weight:600;margin-bottom:6px;"></div>
				<div id="preloaderText" style="font-size:13px;opacity:.85;"></div>
			</div>

			<button id="toggleList" aria-expanded="false">Users</button>
			<button id="themeToggle">Switch</button>
			<div id="cordinates-container"></div>
			<div class="w3-row">
				<div class="w3-col m8">
					<div id="map" style="position:relative; color: #000000; width: 100%; min-height: 100vh; height: 100vh; max-height: 100vh; z-index:0;">
						<div  style="background: rgba(0, 0, 0, 0.85); width: 100%; min-height: 100vh; height: 100vh; max-height: 100vh; z-index: 1;"></div>
					</div>
				</div>
				<div class="w3-col m4">
					<h1 class="w3-center">APRS-Server</h1>
					<div class="w3-container w3-center w3-padding-large">
						<div class="w3-hover-theme-dark" id="userpanel">
						</div>
						</br>
						<div class="w3-center">
							<table class="w3-border-bottom w3-theme-light w3-table" style="border-top-left-radius: 8px; border-top-right-radius: 8px;">
								<thead>
									<tr>
										<td style="width: 10%;">Id</td>
										<td style="width: 90%;">Users: <span id="userinfo" style="text-decoration: none; font-size: 14px;"></span></td>
									</tr>
								</thead>
							</table>
							<div class="w3-scrollbar" style="display: block; height: 650px; overflow-y: scroll;">
								<table class="w3-table">
									<tbody id="userlist">
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<script>
				document.documentElement.classList.add('preload-lock');
				document.body.classList.add('preload-lock');

				var hashusr = "";

				function float2int (value) { return value | 0; }

				if(window.location.hash)
					hashusr = window.location.hash.substr(1).toUpperCase();

				var colors = ['#000000','#592900','#C90000','#FF5900','#EDEB00','#00C900','#0000C9','#FF0094','#00007B','#FFFFFF'];

				var map = L.map('map', {center: [51, 11], zoom: (hashusr == "" ? 7 : 5), minZoom: 3, zoomControl: false, zoomsliderControl: true, maxBounds: worldBounds, maxBoundsViscosity: 1.0});

				var worldBounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
				map.setMaxBounds(worldBounds);
				map.on('drag', function () { map.panInsideBounds(worldBounds, { animate: false }); });

				map.doubleClickZoom.disable();
				map.on('dblclick', function(e) {
					UpdateData('MARKER', 'Never', e.latlng.lat.toFixed(7), e.latlng.lng.toFixed(7), 0, 0, '', 0, '/"', 0, '', '');
				});

				var project = function (map, crs, latlng) {
					return crs.latLngToPoint(latlng, map.getZoom());
				};

				L.TileLayer.prototype._update = function () {
					var bounds = this._map.getPixelBounds(), zoom = this._map.getZoom(), tileSize = this.options.tileSize;

					if (typeof this.options.crs !== 'undefined') {
						bounds.min = project(this._map, this.options.crs, this._map.unproject(bounds.min));
						bounds.max = project(this._map, this.options.crs, this._map.unproject(bounds.max));
					}

					if (zoom > this.options.maxZoom || zoom < this.options.minZoom)
						return;

					var nwTilePoint = new L.Point(Math.floor(bounds.min.x / tileSize), Math.floor(bounds.min.y / tileSize)), seTilePoint = new L.Point(Math.floor(bounds.max.x / tileSize), Math.floor(bounds.max.y / tileSize)), tileBounds = new L.Bounds(nwTilePoint, seTilePoint);
					this._addTilesFromCenterOut(tileBounds);

					if (this.options.unloadInvisibleTiles || this.options.reuseTiles)
						this._removeOtherTiles(tileBounds);
				};

				L.TileLayer.prototype._getTilePos = function (tilePoint) {	
					var origin = this._map.getPixelOrigin(),
					tileSize = this.options.tileSize;

					if (typeof this.options.crs !== 'undefined')
						origin = project(this._map, this.options.crs, this._map.unproject(origin));

					return tilePoint.multiplyBy(tileSize).subtract(origin);
				};

				var openstreetmap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { minZoom: 3, attribution: 'Open Street Map', opacity: 0.75, noWrap: true, continuousWorld: false });
				openstreetmap.addTo(map);

				L.terminator().addTo(map);
				L.control.mousePosition().addTo(map);

				var basemaps = { "Open Street Map": openstreetmap };

				function findMarkersNear(latlng, pxRadius){
				  if (!window.map || !window.marker_cache) return [];
				  var p = map.latLngToLayerPoint(latlng);
				  var near = [];
				  for (var i=0;i<marker_cache.length;i++){
					var mc = marker_cache[i];
					if (!mc || !mc.marker) continue;
					var q = map.latLngToLayerPoint(mc.marker.getLatLng());
					var dx = p.x - q.x, dy = p.y - q.y;
					if ((dx*dx + dy*dy) <= (pxRadius*pxRadius)) near.push(mc);
				  }
				  near.sort(function(a,b){
					var ad = (typeof a.dt === 'number') ? a.dt : Date.parse(a.dt || 0);
					var bd = (typeof b.dt === 'number') ? b.dt : Date.parse(b.dt || 0);
					return bd - ad;
				  });
				  return near;
				}

				function openMarkerChooser(neighbors, atLatLng){
				  var many = neighbors.length > 8;

				  var root = document.createElement('div');
				  root.style.minWidth = '260px';
				  root.style.maxWidth = '340px';
				  root.style.zIndex = '100';

				  var title = document.createElement('div');
				  title.style.fontWeight = '600';
				  title.style.marginBottom = '6px';
				  title.textContent = 'Select a station (' + neighbors.length + ')';
				  root.appendChild(title);

				  var searchBox = null;
				  if (many){
					searchBox = document.createElement('input');
					searchBox.type = 'search';
					searchBox.placeholder = 'Search…';
					searchBox.style.cssText = 'width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:10px;margin-bottom:8px;';
					root.appendChild(searchBox);
				  }

				  var listWrap = document.createElement('div');
				  listWrap.id = 'ovlList';
				  listWrap.style.maxHeight = '260px';
				  listWrap.style.overflow = 'auto';
				  root.appendChild(listWrap);

				  var ul = document.createElement('ul');
				  ul.style.listStyle = 'none';
				  ul.style.margin = '0';
				  ul.style.padding = '0';
				  listWrap.appendChild(ul);

				  function escape(s){ return (s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

				  function render(items){
					ul.innerHTML = '';
					if (!items.length){
					  var li = document.createElement('li');
					  li.style.color = '#999';
					  li.style.padding = '6px 2px';
					  li.textContent = 'No matches';
					  ul.appendChild(li);
					  return;
					}
					for (var i=0;i<items.length;i++){
					  var mc = items[i];
					  var li = document.createElement('li');
					  li.style.margin = '4px 0';

					  var btn = document.createElement('button');
					  btn.type = 'button';
					  btn.setAttribute('data-id', String(mc.id||''));
					  btn.style.cssText = 'width:100%;text-align:left;padding:8px 10px;border:1px solid #ddd;border-radius:10px;background:#fff;display:block;cursor:pointer;';
					  btn.innerHTML =
						'<div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' +
						  escape(mc.user || mc.id || '') +
						'</div>' +
						(mc.comment || mc.status
						  ? '<div style="font-size:12px;color:#666;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + escape(mc.comment || mc.status) + '</div>'
						  : '');

					  li.appendChild(btn);
					  ul.appendChild(li);
					}
				  }

				  render(neighbors);

				  var chooser = L.popup({autoPan:true, closeOnClick:true, className:'ovl-chooser'})
					.setLatLng(atLatLng)
					.setContent(root);

				  L.DomEvent.disableClickPropagation(root);
				  L.DomEvent.disableScrollPropagation(root);

				  root.addEventListener('click', function(ev){
					var btn = ev.target.closest('button[data-id]');
					if (!btn) return;
					ev.preventDefault();
					ev.stopPropagation();
					var id = btn.getAttribute('data-id');
					for (var i=0;i<marker_cache.length;i++){
					  var mc = marker_cache[i];
					  if (String(mc.id) === String(id) && mc.marker){
						map.closePopup(chooser);
						map.panTo(mc.marker.getLatLng());
						mc.marker.openPopup();
						return;
					  }
					}
				  });

				  if (many && searchBox){
					searchBox.addEventListener('input', function(){
					  var f = (searchBox.value || '').trim().toLowerCase();
					  var items = neighbors.filter(function(mc){
						var hay = ((mc.user||'')+' '+(mc.id||'')+' '+(mc.comment||'')+' '+(mc.status||'')).toLowerCase();
						return !f || hay.indexOf(f) !== -1;
					  });
					  render(items);
					});
					setTimeout(function(){ try { searchBox.focus({preventScroll:true}); } catch(_){} }, 0);
				  }

				  chooser.openOn(map);
				}

				var pad = function(num, size) {
					var s = num+"";
					while (s.length < size)
						s = "0" + s;

					return s;
				};

				var marker_cache = [];

				var currentFilter = (localStorage.getItem('srcFilter') || 'all');

				function hasGatewayTag(mc){
					var hay = ((mc.comment||'') + ' ' + (mc.status||'')).toLowerCase();
					return /via\s+(ais|flightaware|dump1090|meshtastic)/i.test(hay);
				}

				function markerMatchesFilter(mc){
					if (currentFilter === 'all') return true;
					if (currentFilter === 'aprs') return !hasGatewayTag(mc);
					var term = currentFilter.toLowerCase();
					var hay = ((mc.comment||'') + ' ' + (mc.status||'')).toLowerCase();
					return hay.indexOf(term) !== -1;
				}

				function onChangeFilter(val){
					currentFilter = val;
					try { localStorage.setItem('srcFilter', currentFilter); } catch(_) {}
					applyFilter();
					try { UpdateStatus(); } catch(_) {}
				}

				function applyFilter(){
					var shown = 0;
					for (var i=0;i<marker_cache.length;i++){
					  var mc = marker_cache[i];
					  var match = markerMatchesFilter(mc);

					  if (match){
						if (mc.marker && !map.hasLayer(mc.marker)) mc.marker.addTo(map);
						if (mc.line && !map.hasLayer(mc.line)) mc.line.addTo(map);
						shown++;
					  } else {
						if (mc.marker && map.hasLayer(mc.marker)) map.removeLayer(mc.marker);
						if (mc.line && map.hasLayer(mc.line)) map.removeLayer(mc.line);
					  }
					}
					try { updateUsersButtonCount(shown); } catch(e){}
					var uinfoEl = document.getElementById('userinfo');
					if (uinfoEl) uinfoEl.innerHTML = ' <b>' + shown + '</b>';
				}

				var UpdateData = function(user,dt,lat,lon,speed,heading,id,age,symbol,registered,comment,status,caption) {
					var needsListRefresh = false;

					if(marker_cache.length == 0)
						map.setView([lat,lon]);

					var sip = symbolToImage(symbol);
					var sipx = '<div style="display:inline-block;overflow:hidden;height:24px;width:24px;font-weight:bold;color:white;text-align:center;padding:3px 1px 1px 1px;font-size:14px;' + sip[0] + '">&nbsp;' + sip[1] + '&nbsp;</div>';	

					var txt = '<div><table cellpadding="1" cellspacing="1" border="0" style="font-size:14px;">';
					txt += '<tr><td width="64">Received:</td><td> '+dt+' UTC</td></tr>';
					txt += '<tr><td width="64" rowspan="3">Position:</td><td style="border-top: solid 1px #fff;"> '+lat + '' + (lat > 0 ? "N" : "S") +' '+lon+''+ (lon > 0 ? "E" : "W") + '</td></tr>';
					var lat2 = pad(Math.floor(lat), 2)  + '&deg;' + pad(((lat - Math.floor(lat)) * 60).toFixed(4), 2) + "'" + (lat > 0 ? "N" : "S");
					var lon2 = pad(Math.floor(lon), 3) + '&deg;' + pad(((lon - Math.floor(lon)) * 60).toFixed(4), 2) + "'" + (lon > 0 ? "E" : "W");
					txt += '<tr><td> '+lat2+' '+lon2+'</td></tr>';
					var lat3 = pad(Math.floor(lat), 2)  + '&deg;' + pad(Math.floor((lat - Math.floor(lat)) * 60), 2) + "'" + pad(((((lat - Math.floor(lat)) * 60) - Math.floor((lat - Math.floor(lat)) * 60)) * 60).toFixed(2),2) + '"' + (lat > 0 ? "N" : "S");
					var lon3 = pad(Math.floor(lon), 3) + '&deg;' + pad(Math.floor((lon - Math.floor(lon)) * 60), 2) + "'" + pad(((((lon - Math.floor(lon)) * 60) - Math.floor((lon - Math.floor(lon)) * 60)) * 60).toFixed(2),2) + '"' + (lon > 0 ? "E" : "W");
					txt += '<tr><td style="border-bottom: solid 1px #fff;"> '+lat3+' '+lon3+'</td></tr>';
					txt += '<tr><td width="64">Speed:</td><td style="border-bottom: solid 1px #fff;"> '+speed+' km/h; '+(speed * 0.62137119).toFixed(1)+' mph; '+(speed / 1.852).toFixed(1)+' knots</td></tr>';
					txt += '<tr><td width="64">Heading:</td><td style="border-bottom: solid 1px #fff;"> '+heading+'&deg; '+HeadingToText(heading)+'</td></tr>';
					txt += '<tr><td width="64">Comment:</td><td style="border-bottom: solid 1px #fff; overflow-wrap:anywhere; word-break:break-word; white-space:normal;">'+comment+'</td></tr>';
					txt += '</div>';

					for(i=0;i<marker_cache.length;i++)
						marker_cache[i].marker.closePopup();

					for(i=0;i<marker_cache.length;i++) {
						if(marker_cache[i].user == user) {
							var mc = marker_cache[i];
							txt = '<table style="width:300px;height:24px;font-size:14px;" celpadding="0" cellspacing="0"><tr><td><b>'+user+'</b> '+(registered ? "&reg;" : "")+'</td><td align="right" style="text-align:right;">'+sipx+'</td></tr></table><div style="width:300px;">' + txt;	

							mc.id = id;
							mc.age = age;
							if(dt != mc.dt) {
								var ci = Math.round(mc.age / 15);
								if(ci > 255)
									ci = 255;
								var opc = 1 - ci / 450;
								ci = 'rgb('+ci+','+ci+','+ci+')';
								$("#usericon"+mc.id).css('opacity',opc);
							};

							if ((lat != mc.lat) || (lon != mc.lon))  {
								mc.llarray.push([lat,lon]);
								mc.lat = lat; mc.lon = lon; 	
								mc.marker.setLatLng([lat,lon]);
								mc.marker.label.setLatLng([lat,lon]);
							};	

							if(mc.symbol != symbol) {
								var si = symbolToImage(symbol);
								$("#usericon"+mc.id)[0].outerHTML = '<div id="usericon'+mc.id+'" class="aprs-usericon" style="'+si[0]+';font-weight:bold;color:white;text-align:center;padding: 3px 1px 3px 1px;">&nbsp;'+si[1]+'&nbsp;</div>';
							};

							if(mc.heading != heading)
								$("#img"+id).css({'-webkit-transform':'rotate('+heading+'deg)','-moz-transform':'rotate('+heading+'deg)','-ms-transform':'rotate('+heading+'deg)','transform':'rotate('+heading+'deg)'});
            
							mc.symbol = symbol; mc.heading = heading; mc.speed = speed; mc.dt = dt;
							mc.marker.bindPopup(txt);

							if(mc.follow)
								map.setView([lat,lon]);

							if(mc.line != null) 
								mc.line.setLatLngs(mc.llarray);
							else if((mc.llarray != null) && (mc.llarray.length > 1)) {
								mc.line = new L.Polyline(mc.llarray,{color:mc.color,weight:3});
								mc.line.addTo(map);
							};

							marker_cache.splice(i, 1);
							marker_cache.push(mc);

							if (needsListRefresh)
								UpdateStatus();

							return;
						};
					};

					for(i=0;i<marker_cache.length;i++) {
						if(marker_cache[i].id == id) {
							var mc = marker_cache[i];
							if (mc.user !== user) { needsListRefresh = true; mc.user = user; }

							txt = '<table style="width:300px;height:24px;font-size:14px;" celpadding="0" cellspacing="0"><tr><td><b>'+user+'</b> '+(registered ? "&reg;" : "")+'</td><td align="right" style="text-align:right;">'+sipx+'</td></tr></table><div style="width:300px;">';

							mc.age = age;
							if(dt != mc.dt) {
								var ci = Math.round(mc.age / 15); if(ci > 255) ci = 255;
								var opc = 1 - ci / 450; ci = 'rgb('+ci+','+ci+','+ci+')';
								$("#usericon"+mc.id).css('opacity',opc);
							}
							if ((lat != mc.lat) || (lon != mc.lon)) {
								mc.llarray.push([lat,lon]);
								mc.lat = lat; mc.lon = lon;
								mc.marker.setLatLng([lat,lon]);
								mc.marker.label.setLatLng([lat,lon]);
							}
							if(mc.symbol != symbol) {
								var si = symbolToImage(symbol);
								$("#usericon"+mc.id)[0].outerHTML = '<div id="usericon'+mc.id+'" class="aprs-usericon" style="'+si[0]+';font-weight:bold;color:white;text-align:center;padding: 3px 1px 3px 1px;">&nbsp;'+si[1]+'&nbsp;</div>';
								}
							if(mc.heading != heading)
								$("#img"+id).css({'-webkit-transform':'rotate('+heading+'deg)','-moz-transform':'rotate('+heading+'deg)','-ms-transform':'rotate('+heading+'deg)','transform':'rotate('+heading+'deg)'});

							mc.symbol = symbol; mc.heading = heading; mc.speed = speed; mc.dt = dt;
							mc.marker.bindPopup(txt);
							if(mc.follow) map.setView([lat,lon]);
							if(mc.line != null) mc.line.setLatLngs(mc.llarray);
							else if((mc.llarray != null) && (mc.llarray.length > 1)) {
								mc.line = new L.Polyline(mc.llarray,{color:mc.color,weight:3}); mc.line.addTo(map);
							}
							marker_cache.splice(i,1);
							marker_cache.push(mc);
							if (needsListRefresh) UpdateStatus();
							return;
						}
					}

					var symba = symbolToImage(symbol);
					var symbolImage = symba[0];

					txt = '<table style="width:300px;height:24px;font-size:14px;" celpadding="0" cellspacing="0"><tr><td><b>'+user+'</b> '+(registered ? "&reg;" : "")+'</td><td align="right" style="text-align:right;">'+sipx+'</td></tr></table><div style="width:300px;">' + txt;
					var mc = {"user":user,"lat":lat,"lon":lon,"heading":heading,"speed":speed,"dt":dt,"id":id,"age":age,"symbol":symbol,"status":status};
					mc.color = colors[id % 10];
					mc.follow = false;
					mc.comment = comment;
					mc.status  = status;
					mc.llarray = [[lat,lon]];
					mc.tableicon = symbolImage;
					mc.line = null;
					mc.icon = new L.DivIcon({className: 'aprs-clear', html: '<div id="usericon'+id+'" class="aprs-usericon" style="'+symbolImage+';font-weight:bold;color:white;text-align:center;padding: 3px 1px 3px 1px;"><img id="img'+id+'" src="style/arrow.png" class="aprs-hdg"/>&nbsp;'+symba[1]+'&nbsp;</div>'});
					mc.marker = new L.Marker([lat,lon],{icon: mc.icon, riseOnHover:true});
					mc.marker.bindPopup(txt);
					mc.marker.bindLabel(typeof caption !== 'undefined' ? caption : user, { direction: 'right', noHide:true });
					mc.marker.addTo(map);
					mc.marker.on('click', function(e){
					  try {
						var near = findMarkersNear(e.latlng, 18);
						if (near.length > 1) {
						  openMarkerChooser(near, e.latlng);
						  L.DomEvent.stop(e);
						  return false;
						}
					  } catch(_) {}
					});

					$("#img"+id).css({'-webkit-transform' : 'rotate('+ mc.heading +'deg)','-moz-transform' : 'rotate('+ mc.heading +'deg)','-ms-transform' : 'rotate('+ mc.heading +'deg)','transform' : 'rotate('+ mc.heading +'deg)'});

					var ci = Math.round(mc.age / 15);
					if(ci > 255)
						ci = 255;
					var opc = 1 - ci / 450;
					ci = 'rgb('+ci+','+ci+','+ci+')';
					$("#usericon"+id).css('opacity',opc);

					marker_cache.push(mc);
					UpdateStatus();

					try { applyFilter(); } catch(e){}
				}

				var symbolToImage = function(symb) {
					var prose = 'primary';
					var label = '';
					if(symb.length == 2) {
						if(symb[0] == '\\') 
							prose = 'secondary';
						else if ((symb[0] != '/') && (("#&0>AW^_acnsuvz").indexOf(symb[1]) >= 0)) {
							prose = "secondary";
							label = symb[0].toString();
							if (("#0A^cv").indexOf(symb[1]) >= 0) {
								label = "<span style=\"color:black;\">" + label + "</span>";
							};
						};
						symb = symb.substr(1);
					};
					var symbtable = '!"#$%&\'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~';
					var idd = symbtable.indexOf(symb);
					if(idd < 0)
						idd = 14;
					var itop =  Math.floor(idd / 16) * 24;
					var ileft = (idd % 16) * 24;

					return ['background:url(style/'+ prose +'.png) -'+ileft+'px -'+itop+'px no-repeat;', label];
				}

				var HeadingToText = function(hdg) {
					var d = Math.round(hdg / 22.5);
					switch (d) {
						case 0: return "N";
						case 1: return "NNE";
						case 2: return "NE";
						case 3: return "NEE";
						case 4: return "E";
						case 5: return "SEE";
						case 6: return "SE";
						case 7: return "SSE";
						case 8: return "S";
						case 9: return "SSW";
						case 10: return "SW";
						case 11: return "SWW";
						case 12: return "W";
						case 13: return "NWW";
						case 14: return "NW";
						case 15: return "NNW";
						case 16: return "N";
						default: return "";
					};
				}

				var APRS_RX = /^(\d{1,2}:\d{1,2}:\d{1,2}\s\d{1,2}\.\d{1,2}\.\d{2,4}\sUTC)\s(\S+)\s>>\s(-?\d+(?:\.\d+)?)\s(-?\d+(?:\.\d+)?)\s([\d.\-]+)\s(\d+)\s(\d+)\s(\S\S)/;

				function isRealAprsLine(s){
					var m = APRS_RX.exec(s);
					if (!m) return false;
					var lat = parseFloat(m[3]), lon = parseFloat(m[4]);
					if (!isFinite(lat) || !isFinite(lon)) return false;
					if (Math.abs(lat) > 90 || Math.abs(lon) > 180) return false;
					return true;
				}

				var userdata_total = 0;
				function loadUserdataThenConnect(done){
					fetch("/userdata", { cache: "no-store" }).then(function(r){ return r.text(); }).then(function(text){
						userdata_total = 0;
						if (text && text.indexOf("UTC") !== -1) {
							var lines = text.split(/\r?\n/);
							(function applyBatch(i){
								var end = Math.min(i + 2000, lines.length);
								for (var k = i; k < end; k++) {
									var ln = lines[k];
									if (!ln) continue;
									if (isRealAprsLine(ln))
										userdata_total++;
								}
								if (end < lines.length)
									setTimeout(function(){ applyBatch(end); }, 8);
								else
									if (typeof done === "function") done();
							})(0);
						} else {
							if (typeof done === "function") done();
						}
					}).catch(function(){ if (typeof done === "function") done(); });
				}

				var UpdateStatus = function() {
					var html = '<input class="w3-input w3-border w3-round-large" type="text" id="Locate" onkeyup="onLocate(event)" placeholder="Locate / Callsign" value="'+hashusr+'"></input></br>';
					html += '<a class="w3-button w3-theme-button w3-hover-theme-button w3-round-large" style="text-decoration:none;" href="#" onclick="onReset(event)">Reset</a> ';
					html += '<a class="w3-button w3-theme-button w3-hover-theme-button w3-round-large" style="text-decoration:none;" href="#" onclick="onFollow(event)">Follow User</a> ';
					html += '<a class="w3-button w3-theme-button w3-hover-theme-button w3-round-large" style="text-decoration:none;" href="#" onclick="ClearPath();return false;">Clear Path</a> ';
					html += '<a class="w3-button w3-theme-button w3-hover-theme-button w3-round-large" style="text-decoration:none;" href="#" onclick="ClearMap();return false;">Clear All</a>';

					html += '<div style="margin-top:10px"></div>';
					html += '<label class="w3-small" for="sourceFilter">Source filter:</label> ';
					html += '<select id="sourceFilter" class="w3-select w3-round-large w3-theme-light" ' +
							'onchange="onChangeFilter(this.value)" style="max-width:260px;">' +
							'<option value="all">Show: All</option>' +
							'<option value="aprs">Show: APRS only</option>' +
							'<option value="via AIS">Show: via AIS</option>' +
							'<option value="via FlightAware">Show: via FlightAware</option>' +
							'<option value="via dump1090">Show: via dump1090</option>' +
							'<option value="via Meshtastic">Show: via Meshtastic</option>' +
							'</select>';

					$("#userpanel").html(html);

					try { document.getElementById('sourceFilter').value = currentFilter; } catch(e){}

					var string1 = "0", string2 = "0", result = "0";

					var table_row = 'w3-theme-dark', udt = '', ulist = '';
					var displayCount = 0, displayMSGCount = 0;
					if (marker_cache.length > 0) {
						for (i = marker_cache.length - 1; i >= 0; i--) {
						    if (!markerMatchesFilter(marker_cache[i])) continue;
								displayCount++;

							if (i > (userdata_total * 0.9)) {
								displayMSGCount++;

								if (table_row == "w3-theme-table")
									table_row = "w3-theme-dark";
								else
									table_row = "w3-theme-table";

								if (marker_cache[i].dt.toString() != udt.toString())
									ulist += '<tr class="w3-border-bottom w3-theme-light"><td colspan="3"><b class="w3-tiny">'+ marker_cache[i].dt +'</b></td></tr>';

								ulist += '<tr class="'+ table_row +'">';
								ulist += '<td class="w3-border-bottom" style="width: 10%;">'+ (displayMSGCount) +'</td>';
								ulist += '<td class="w3-border-bottom" style="width: 90%;"><div><a class="w3-hover-theme-dark w3-hover-text-theme" style="text-decoration: none;" href="#" onclick="Locate(\''+ marker_cache[i].user +'\');return false;"><div class="w3-image" style="float: left; '+ marker_cache[i].tableicon +'; height: 24px; width: 24px;"></div> <b>'+ marker_cache[i].user +'</b></a> | <small>Position: '+ marker_cache[i].lat +' / '+ marker_cache[i].lon +'</small></div></br><small>'+ marker_cache[i].comment +'</small></td>';
								ulist += '</tr>';

								udt = marker_cache[i].dt;
							}
						}
					} else {
						ulist = '<tr><td colspan="3">NONE</td></tr>';
					};
					$("#userlist").html(ulist);

					var uinfo = ' <b>'+ displayCount +'</b>';
					$("#userinfo").html(uinfo);

					try { updateUsersButtonCount(marker_cache.length); } catch(e){}
					try { if (marker_cache.length) __openUserSheetOnce(); } catch(e){}
				}

				var Locate = function(u) {
					for(i=0;i<marker_cache.length;i++) 
						if(marker_cache[i].user == u)
							map.setView([marker_cache[i].lat,marker_cache[i].lon]);

					$("#Locate").val(u);
				}

				var onLocate = function(e) {
					if(e.keyCode != 13)
						return;	

					var usr = document.getElementById('Locate').value.toString().toUpperCase();
					Locate(usr);
				}

				var onFollow = function(e) {
					hashusr = $("#Locate").val();
					Follow();
				}

				var onReset = function(e) {
					document.getElementById('Locate').value = "";
					hashusr = "";
				}

				var ClearPath = function() {
					for(i=0;i<marker_cache.length;i++) {	
						if(marker_cache[i].line != null)
							map.removeLayer(marker_cache[i].line);
						marker_cache[i].line = null;
						marker_cache[i].llarray = [[marker_cache[i].lat,marker_cache[i].lon]];
					};
				};

				var ClearMap = function() {
					for(i=0;i<marker_cache.length;i++) {	
						if(marker_cache[i].line != null)
							map.removeLayer(marker_cache[i].line);
						marker_cache[i].line = null;
						map.removeLayer(marker_cache[i].marker);	
						marker_cache[i].marker = null;
					};
					marker_cache = [];
					UpdateStatus();
				};

				var ClearStatic = function() {
					var tmpa = [];
					for(i=0;i<marker_cache.length;i++) {
						if(marker_cache[i].id < 0) {
							map.removeLayer(marker_cache[i].marker);	
							marker_cache[i].marker = null;
						} else 
							tmpa.push(marker_cache[i]);
					};
					marker_cache = tmpa;
					UpdateStatus();
				};

				var UpdateBuddies = function() {
					for(i=0;i<marker_cache.length;i++)  {
						marker_cache[i].age += 15;
						var ci = Math.round(marker_cache[i].age / 15);
						if(ci > 255)
							ci = 255;
						var opc = 1 - ci / 450;
						ci = 'rgb('+ci+','+ci+','+ci+')';
						$("#usericon"+marker_cache[i].id).css('opacity',opc);
					};
					setTimeout(UpdateBuddies,5000);
				};

				var UpdateFromWebSocket = function(data) {
					if (data instanceof Blob) {
						var reader = new FileReader();
						reader.onload = () => { UpdateFromWebSocket(reader.result); };
						reader.readAsText(data);
						return;
					};

					if(data.indexOf(">>") < 0)
						return;

					var aCom = data.match(/^(\d{1,2}:\d{1,2}:\d{1,2}\s\d{1,2}.\d{1,2}.\d{2,4}\sUTC)\s(\S+)\s>>\s([\d.\-]+)\s([\d.\-]+)\s([\d.\-]+)\s(\d+)\s(\d+)\s(\S\S)/);	
					if((aCom == null) || (aCom.length == 0))
						return;

					var comment = data;
					if (comment.includes("A=")) {
						comment = comment.split("A=").pop();
						comment = comment.slice(6);
					} else if (comment.includes(aCom[8])) {
						comment = comment.split(aCom[8]).pop();
					};
					UpdateData(aCom[2],new Date(),parseFloat(aCom[3]),parseFloat(aCom[4]),parseInt(aCom[7]),parseInt(aCom[6]),aCom[2],0,aCom[8],0,comment,data);
					if(hashusr == aCom[2])
						Follow();
				}	

				var Follow = function() {
					if(hashusr != "") {
						for(i=0;i<marker_cache.length;i++) 
							if(marker_cache[i].user == hashusr)
								map.setView([marker_cache[i].lat,marker_cache[i].lon]);
					};
				}

				UpdateStatus();
				UpdateBuddies();
				applyFilter();

				var socket = null;
				var Reconnect = function() { 
					var socket_url = 'ws://'+location.hostname+':8060/';
					socket = new WebSocket(socket_url);
					socket.onopen = function() { };
					socket.onmessage = function (evt) {
						UpdateFromWebSocket(evt.data);
					};
					socket.onclose = function() { 
						alert('Connection with server has been lost!\r\nPlease reload page to connect again\r\nor just click OK button to try'); 
						Reconnect();
					};
				};

				loadUserdataThenConnect(function(){ Reconnect(); });

				function iss_fetch_data () {
					fetch("https://api.wheretheiss.at/v1/satellites/25544").then((response) => response.json()).then((iss) => {
						UpdateData('ARISS-10', new Date(), iss.latitude, iss.longitude, float2int (iss.velocity), 0, '', 0, '\S', 0, 'International Space Station', '');

						fetch("https://api.wheretheiss.at/v1/satellites/25544").then((response) => response.json()).then((iss) => { setTimeout(iss_fetch_data, 15000); })
					});
				}
				iss_fetch_data ();

				(function(){
					const KEY = 'ui-theme';
					const root = document.documentElement;
					const saved = localStorage.getItem(KEY);
					if (saved === 'dark' || saved === 'light')
						root.setAttribute('data-theme', saved === 'dark' ? 'dark' : '');
					document.getElementById('themeToggle').addEventListener('click', () => {
						const isDark = root.getAttribute('data-theme') === 'dark';
						const next = isDark ? 'light' : 'dark';
						if (next === 'light') root.removeAttribute('data-theme'); else root.setAttribute('data-theme','dark');
						localStorage.setItem(KEY, next);
					});
				})();

				(function(){
					var panel = document.querySelector('.w3-col.m4');
					var btn   = document.getElementById('toggleList');
					if(!panel || !btn) return;

					function setOpen(open){
						var isOpen = (open !== undefined) ? open : !panel.classList.contains('open');
						panel.classList.toggle('open', isOpen);
						btn.setAttribute('aria-expanded', String(isOpen));
					}
					btn.addEventListener('click', function(){ setOpen(); });

					var _UpdateStatus = window.UpdateStatus;
					window.UpdateStatus = function(){
						try { _UpdateStatus(); } catch(e){}
						try {
							btn.textContent = (typeof marker_cache !== 'undefined' && marker_cache) ? ('Users (' + marker_cache.length + ')') : 'Users';
							if (window.matchMedia('(max-width:768px)').matches && marker_cache && marker_cache.length && !panel.__firstOpenDone){
								setOpen(true); panel.__firstOpenDone = true;
							}
						} catch(e){}
					};
				})();

			  (function(){
				var pre = document.getElementById('preloader');
				var title = document.getElementById('preloaderTitle');
				var text  = document.getElementById('preloaderText');

				title.textContent = 'Please wait...';

				function showPreloader(msg1, msg2){
				  if (!pre) return;
				  if (msg1) title.textContent = msg1;
				  if (msg2) text.textContent  = msg2;
				  pre.hidden = false;
				}
				function hidePreloader(){
				  if (!pre) return;
				  pre.hidden = true;
				  setTimeout(function(){
					document.documentElement.classList.remove('preload-lock');
					document.body.classList.remove('preload-lock');
				  }, 400);
				}

				var firstStatusSeen = false;

				var _UpdateStatus = window.UpdateStatus;
				window.UpdateStatus = function(){
				  try { _UpdateStatus(); } catch(e){}

				  try {
					var count = (typeof marker_cache !== 'undefined' && marker_cache) ? marker_cache.length : 0;
					if (pre && !firstStatusSeen) {
					  text.textContent  = 'Loaded ' + count + ' User' + (count===1?'':'s');
					} else if (pre) {
					  text.textContent  = 'Loaded ' + count + ' User' + (count===1?'':'s');
					}
					firstStatusSeen = true;
					maybeDone();
				  } catch(e){}
				};

				try { map.once('load', maybeDone); } catch(e){}

				function maybeDone(){
				  if (firstStatusSeen) {
					setTimeout(hidePreloader, 400);
				  }
				}

				setTimeout(function(){
				  if (!firstStatusSeen) { title.textContent = 'Starting…'; }
				  if (pre && !pre.hidden) { hidePreloader(); }
				}, 10000);
			  })();

			function setMarkersHidden(hidden){
			  var mc = window.marker_cache || [];
			  for (var i = 0; i < mc.length; i++){
				var m = mc[i]; if (!m) continue;

				if (m.marker && m.marker.setOpacity) {
				  m.marker.setOpacity(hidden ? 0 : 1);
				}

				try {
				  if (m.marker && m.marker.hideLabel && m.marker.showLabel) {
					if (hidden) m.marker.hideLabel(); else m.marker.showLabel();
				  }
				} catch(_) {}

				try {
				  if (m.line) {
					if (hidden && map.hasLayer(m.line)) map.removeLayer(m.line);
					if (!hidden && !map.hasLayer(m.line)) m.line.addTo(map);
				  }
				} catch(_) {}
			  }
			}

			(function(){
				if (!window.L || !L.heatLayer) return;

				if (!window.heatLayer)
					window.heatLayer = L.heatLayer([], { radius:22, blur:16, maxZoom:18, minOpacity:0.5 });

				function rebuildHeatFromMarkers(){
					if (!window.map || !window.heatLayer) return;
					var mc = window.marker_cache || [];
					var pts = [];
					for (var i = 0; i < mc.length; i++){
						var m = mc[i]; if (!m) continue;
						var lat = parseFloat(m.lat), lon = parseFloat(m.lon);
						if (!isFinite(lat) || !isFinite(lon)) continue;

						var w = 0.6;
						if (m.speed != null) {
							var sp = parseFloat(m.speed);
							if (isFinite(sp)) w = sp > 120 ? 0.9 : (sp > 60 ? 0.75 : 0.6);
						}
						pts.push([lat, lon, w]);
					}
					window.heatLayer.setLatLngs(pts);
					try { window.heatLayer.bringToFront(); } catch(e){}
				}

				function heatAllowed(){
					if (!window.map) return false;
					var z = map.getZoom();
					return z >= 3 && z <= 5;
				}

				function ensureHeatVisibility(){
					if (!window.map || !window.heatLayer) return;
					if (heatAllowed()) {
						if (!map.hasLayer(window.heatLayer)) {
							window.heatLayer.addTo(map);
							rebuildHeatFromMarkers();
						} else {
							rebuildHeatFromMarkers();
						}
						setMarkersHidden(true);
					} else {
						if (map.hasLayer(window.heatLayer)) map.removeLayer(window.heatLayer);
						setMarkersHidden(false);
					}
				}

				var _heatTimer = null;
				function scheduleHeatRebuild(){
					if (_heatTimer) clearTimeout(_heatTimer);
					_heatTimer = setTimeout(function(){
						if (heatAllowed()) rebuildHeatFromMarkers();
					}, 200);
				}

				if (typeof window.UpdateFromWebSocket === 'function' && !window.__heatZoomWrapped){
					window.__heatZoomWrapped = true;
					var __oldU = window.UpdateFromWebSocket;
					window.UpdateFromWebSocket = function(){
						var r = __oldU.apply(this, arguments);
						scheduleHeatRebuild();
						return r;
					};
				}

				if (window.map && !window.__heatZoomHooked){
					window.__heatZoomHooked = true;
					map.on('zoomend', ensureHeatVisibility);
				}

				if (window.map) ensureHeatVisibility();
				else setTimeout(ensureHeatVisibility, 400);
			})();
			</script>
		</body>
	</html>
